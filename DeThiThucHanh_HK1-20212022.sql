-- CƠ SỞ DỮ LIỆU
-- ĐỀ THI THỰC HÀNH - HỌC KỲ 1 NĂM HỌC 2021-2022

-- Câu 1. Cài đặt lược đồ CSDL trên, khai báo khóa chính, khóa ngoại
CREATE DATABASE QUANLY_CONGTY
USE QUANLY_CONGTY

-- Table: NHANVIEN --
CREATE TABLE NHANVIEN (
	MANV VARCHAR(3) NOT NULL PRIMARY KEY,
	HOTEN VARCHAR(40),
	NGSINH SMALLDATETIME,
	PHAI VARCHAR(3),
	DIACHI VARCHAR(50),
	MAPHG VARCHAR(2),
	LUONG MONEY
)

-- Table: PHONGBAN --
CREATE TABLE PHONGBAN (
	MAPHG VARCHAR(2) NOT NULL PRIMARY KEY,
	TENPHG VARCHAR(50),
	TRPHG VARCHAR(3),
	NGNC SMALLDATETIME
)

-- Table: DEAN --
CREATE TABLE DEAN (
	MADA VARCHAR(5) NOT NULL PRIMARY KEY,
	TENDA VARCHAR(50),
	DDIEM_DA VARCHAR(50),
	MAPHG VARCHAR(2),
	NGBD_DK SMALLDATETIME,
	NGKT_DK SMALLDATETIME
)

-- Table: PHANCONG --
CREATE TABLE PHANCONG (
	MANV VARCHAR(3) NOT NULL,
	MADA VARCHAR(5) NOT NULL,
	THOIGIAN INT,
	CONSTRAINT PK_PHANCONG PRIMARY KEY (MANV, MADA)
)

-- FOREIGN KEY --
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_MAPHG_NHANVIEN_PHONGBAN FOREIGN KEY (MAPHG) REFERENCES PHONGBAN (MAPHG)
ALTER TABLE PHONGBAN ADD CONSTRAINT FK_TRPHG_PHONGBAN_NHANVIEN FOREIGN KEY (TRPHG) REFERENCES NHANVIEN (MANV)
ALTER TABLE DEAN ADD CONSTRAINT FK_MAPHG_DEAN_PHONGBAN FOREIGN KEY (MAPHG) REFERENCES PHONGBAN (MAPHG)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_MANV_PHANCONG_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN (MANV)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_MADA_PHANCONG_DEAN FOREIGN KEY (MADA) REFERENCES DEAN (MADA)



-- Câu 2. Hiện thực ràng buộc toàn vẹn
--	a.	Nhân viên phòng "NC" phải có lương lớn hơn 20.000.000.


--	b.	Nhân viên chỉ được phân công vào các đề án có ngày dự kiến bắt đầu thực hiện đề án (NGBD_DK) lớn hơn ngày sinh của nhân viên đó (NGSINH).





-- Câu 3. Thực hiện các câu truy vấn sau:
--	a.	Cho biết tên phòng ban (TENPHG) có mức lương trung bình từ 24.000.000 trở lên, sắp xếp theo tên phòng ban giảm dần.
-- Cách 1:
SELECT TENPHG
FROM PHONGBAN
WHERE EXISTS (
	SELECT *
	FROM NHANVIEN
	WHERE PHONGBAN.MAPHG = NHANVIEN.MAPHG
	GROUP BY MAPHG
	HAVING AVG(LUONG) >= 24000000
)
ORDER BY TENPHG DESC

-- Cách 2:
SELECT TENPHG, AVG(LUONG)
FROM PHONGBAN, NHANVIEN
WHERE PHONGBAN.MAPHG = NHANVIEN.MAPHG
GROUP BY TENPHG
HAVING AVG(LUONG) >= 24000000
ORDER BY TENPHG DESC


--	b.	Liệt kê thông tin nhân viên (HOTEN) tham gia đề án của phòng "Nghien Cuu" có địa điểm thực hiện đề án tại "HANOI".
SELECT NHANVIEN.HOTEN
FROM NHANVIEN, PHONGBAN, DEAN, PHANCONG
WHERE NHANVIEN.MANV = PHANCONG.MANV AND DEAN.MADA = PHANCONG.MADA AND DEAN.MAPHG = PHONGBAN.MAPHG
	AND PHONGBAN.TENPHG = 'Nghien Cuu' AND DEAN.DDIEM_DA = 'HANOI'


--	c.	Liệt kê tên nhân viên (HOTEN) và số đề án mà nhân viên đó tham gia.
SELECT NHANVIEN.HOTEN, COUNT(MADA) AS SODEAN_THAMGIA
FROM PHANCONG, NHANVIEN
WHERE PHANCONG.MANV = NHANVIEN.MANV
GROUP BY (HOTEN)


--	d.	Tìm nhân viên (HOTEN) chỉ tham gia những đề án do phòng "Nghien Cuu" chủ trì.
SELECT NHANVIEN.HOTEN
FROM NHANVIEN, PHANCONG
WHERE NHANVIEN.MANV = PHANCONG.MANV
EXCEPT
SELECT NHANVIEN.HOTEN
FROM NHANVIEN, PHANCONG, DEAN, PHONGBAN
WHERE NHANVIEN.MANV = PHANCONG.MANV AND DEAN.MADA = PHANCONG.MADA AND PHONGBAN.MAPHG = DEAN.MAPHG
	AND TENPHG != 'Nghien Cuu'


--	e.	Tìm họ tên (HOTEN) của các nhân viên làm việc cho tất cả đề án do phòng "Dieu Hanh" chủ trì.
SELECT NHANVIEN.HOTEN
FROM NHANVIEN
WHERE NOT EXISTS (
	SELECT *
	FROM PHONGBAN, DEAN
	WHERE PHONGBAN.MAPHG = DEAN.MAPHG
	AND PHONGBAN.TENPHG = 'Dieu Hanh' AND NOT EXISTS (
		SELECT *
		FROM PHANCONG
		WHERE PHANCONG.MANV = NHANVIEN.MANV AND DEAN.MADA = PHANCONG.MADA
	)
)


--	f.	Cho biết tên phòng ban cùng họ tên trưởng phòng của phòng ban có đông nhân viên nhất.
SELECT PHONGBAN.TENPHG, NHANVIEN.HOTEN
FROM PHONGBAN, NHANVIEN
WHERE PHONGBAN.TRPHG = NHANVIEN.MANV AND PHONGBAN.MAPHG IN (
	SELECT TOP 1 WITH TIES PHONGBAN.MAPHG
	FROM PHONGBAN, NHANVIEN
	WHERE PHONGBAN.MAPHG = NHANVIEN.MAPHG
	GROUP BY PHONGBAN.MAPHG
	ORDER BY COUNT(MANV) DESC
)





---------- nhập dữ liệu mẫu ----------
SET DATEFORMAT DMY

-- Thông tin nhân viên [NHANVIEN]
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES
('001', 'Vuong Ngoc Quyen', '22/10/1977', 'Nu', '450 Trung Vuong, HaNoi', NULL, 30000000),
('002', 'Nguyen Thanh Tu', '09/01/1975', 'Nam', '731 Tran Hung Dao, Q1, TpHCM', NULL, 25000000),
('003', 'Le Thi Nhan', '18/12/1980', 'Nu', '291 Ho Van Hue, QPN, TpHCM', NULL, 25000000),
('004', 'Dinh Ba Tien', '09/01/1988', 'Nam', '638 Nguyen Van Cu, Q5, TpHCM', NULL, 22000000),
('005', 'Bui Thuy Vu', '19/07/1992', 'Nam', '332 Nguyen Thai Hoc, Q1, TpHCM', NULL, 23000000)

-- Thông tin phòng ban [PHONGBAN]
INSERT INTO PHONGBAN (MAPHG, TENPHG, TRPHG, NGNC) VALUES
('QL', 'Quan Ly', '001', '22/05/2018'),
('DH', 'Dieu Hanh', '003', '10/10/2020'),
('NC', 'Nghien Cuu', '002', '15/03/2020')

-- Update MAPHG trong bảng NHANVIEN sau khi đã Insert xong các thông tin của phòng ban [PHONGBAN]
UPDATE NHANVIEN SET MAPHG = 
	CASE
		WHEN MANV = '001' THEN 'QL'
		WHEN MANV = '002' THEN 'NC'
		WHEN MANV = '003' THEN 'DH'
		WHEN MANV = '004' THEN 'NC'
		WHEN MANV = '005' THEN 'DH'
	END

-- Thông tin đề án [DEAN]
INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES
('TH001', 'Tin hoc hoa 1', 'HANOI', 'NC', '01/02/2018', '01/02/2019'),
('TH002', 'Tin hoc hoa 2', 'TPHCM', 'NC', '04/06/2018', '01/02/2019'),
('DT001', 'Dao tao 1', 'NHATRANG', 'DH', '01/02/2017', '01/02/2021'),
('DT002', 'Dao tao 2', 'HANOI', 'DH', '01/02/2017', '01/02/2021')

-- Thông tin phân công [PHANCONG]
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES
('001', 'TH001', 30),
('001', 'TH002', 12),
('002', 'TH001', 10),
('002', 'TH002', 10),
('002', 'DT001', 10),
('002', 'DT002', 10),
('003', 'TH001', 37),
('004', 'DT001', 22),
('004', 'DT002', 10)


